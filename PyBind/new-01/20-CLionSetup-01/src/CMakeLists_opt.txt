# ---- Python ----
# Prefer project venv if present, otherwise fall back to system python
if(EXISTS "${CMAKE_SOURCE_DIR}/.venv/bin/python")
        set(Python3_EXECUTABLE "${CMAKE_SOURCE_DIR}/.venv/bin/python")
        message(STATUS "Using project venv Python: ${Python3_EXECUTABLE}")
else()
        execute_process(COMMAND which python3 OUTPUT_VARIABLE Python3_EXECUTABLE OUTPUT_STRIP_TRAILING_WHITESPACE)
        if(NOT Python3_EXECUTABLE)
                execute_process(COMMAND which python OUTPUT_VARIABLE Python3_EXECUTABLE OUTPUT_STRIP_TRAILING_WHITESPACE)
        endif()
        message(STATUS "Using system Python: ${Python3_EXECUTABLE}")
endif()

# Require a modern Python 3 (pybind11 supports 3.7+); adjust minimum if needed
find_package(Python3 3.7 REQUIRED COMPONENTS Interpreter Development)

# Discover the site-packages (purelib) directory for the chosen Python
execute_process(
        COMMAND "${Python3_EXECUTABLE}" -c "import sysconfig; print(sysconfig.get_paths()['purelib'])"
        OUTPUT_VARIABLE PY_SITE_PACKAGES
        OUTPUT_STRIP_TRAILING_WHITESPACE
)
message(STATUS "Python site-packages detected: ${PY_SITE_PACKAGES}")

# ---- pybind11 ----
include(FetchContent)
FetchContent_Declare(
        pybind11
        GIT_REPOSITORY https://github.com/pybind/pybind11.git
        GIT_TAG v2.11.1
)
FetchContent_MakeAvailable(pybind11)

# ---- Core C++ library ----
add_library(my_api
        api/my_api.cpp
        )

target_include_directories(my_api
        PUBLIC
        ${CMAKE_CURRENT_SOURCE_DIR}
        )

target_compile_features(my_api PUBLIC cxx_std_17)

# ---- C++ executable ----
add_executable(my_app
        main.cpp
        )

target_link_libraries(my_app
        PRIVATE my_api
        )

# ---- Python module (pybind11) ----
pybind11_add_module(my_api_py
        bindings/pybind_module.cpp
        )

target_link_libraries(my_api_py
        PRIVATE my_api
        )

# Install directly into venv site-packages when project .venv exists
if(PY_SITE_PACKAGES)
        # Ensure the target directory exists and set output there
        add_custom_command(TARGET my_api_py
                                           POST_BUILD
                                           COMMAND ${CMAKE_COMMAND} -E make_directory "${PY_SITE_PACKAGES}"
                                           COMMENT "Ensuring Python site-packages exists: ${PY_SITE_PACKAGES}")

        set_target_properties(my_api_py PROPERTIES
                        LIBRARY_OUTPUT_DIRECTORY "${PY_SITE_PACKAGES}"
                        )
        message(STATUS "Python module will be built into: ${PY_SITE_PACKAGES}")
else()
        set_target_properties(my_api_py PROPERTIES
                        LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/python
                        )
        message(STATUS "Python module will be built into: ${CMAKE_BINARY_DIR}/python")
endif()
